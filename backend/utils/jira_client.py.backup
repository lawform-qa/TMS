"""
JIRA API 클라이언트
실제 JIRA API와 Mock JIRA 서버 모두 지원
"""

import requests
import json
from datetime import datetime
from typing import Dict, List, Optional, Any
import os

class JiraClient:
    """JIRA API 클라이언트"""
    
    def __init__(self, server_url: str = None, username: str = None, api_token: str = None):
        """
        JIRA 클라이언트 초기화
        
        Args:
            server_url: JIRA 서버 URL (기본값: Mock 서버)
            username: JIRA 사용자명
            api_token: JIRA API 토큰
        """
        self.server_url = server_url or os.getenv('JIRA_SERVER_URL', 'http://localhost:5004')
        self.username = username or os.getenv('JIRA_USERNAME', 'admin')
        self.api_token = api_token or os.getenv('JIRA_API_TOKEN', 'mock-token')
        
        # 세션 설정
        self.session = requests.Session()
        self.session.auth = (self.username, self.api_token)
        self.session.headers.update({
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        })
        
        # 기본 프로젝트 키
        self.default_project_key = os.getenv('JIRA_PROJECT_KEY', 'TEST')
        self.default_issue_type = os.getenv('JIRA_DEFAULT_ISSUE_TYPE', 'Task')
    
    def _make_request(self, method: str, endpoint: str, data: Dict = None, params: Dict = None) -> Dict:
        """JIRA API 요청 실행"""
        url = f"{self.server_url}{endpoint}"
        
        try:
            if method.upper() == 'GET':
                response = self.session.get(url, params=params)
            elif method.upper() == 'POST':
                response = self.session.post(url, json=data)
            elif method.upper() == 'PUT':
                response = self.session.put(url, json=data)
            elif method.upper() == 'DELETE':
                response = self.session.delete(url)
            else:
                raise ValueError(f"Unsupported HTTP method: {method}")
            
            response.raise_for_status()
            return response.json() if response.content else {}
            
        except requests.exceptions.RequestException as e:
            raise Exception(f"JIRA API 요청 실패: {str(e)}")
    
    def create_issue(self, 
                    project_key: str = None,
                    summary: str = None,
                    description: str = "",
                    issue_type: str = None,
                    priority: str = "Medium",
                    assignee: str = None,
                    labels: List[str] = None,
                    **kwargs) -> Dict:
        """
        JIRA 이슈 생성
        
        Args:
            project_key: 프로젝트 키
            summary: 이슈 요약
            description: 이슈 설명
            issue_type: 이슈 타입 (Bug, Task, Story, Epic)
            priority: 우선순위 (Low, Medium, High, Critical)
            assignee: 담당자 계정 ID
            labels: 라벨 목록
            **kwargs: 추가 필드
            
        Returns:
            생성된 이슈 정보
        """
        project_key = project_key or self.default_project_key
        issue_type = issue_type or self.default_issue_type
        
        if not summary:
            raise ValueError("이슈 요약(summary)은 필수입니다.")
        
        # 이슈 생성 데이터 구성
        issue_data = {
            'fields': {
                'project': {'key': project_key},
                'summary': summary,
                'description': description,
                'issuetype': {'name': issue_type},
                'priority': {'name': priority}
            }
        }
        
        # 선택적 필드 추가
        if assignee:
            issue_data['fields']['assignee'] = {'accountId': assignee}
        
        if labels:
            issue_data['fields']['labels'] = labels
        
        # 추가 필드 병합
        if 'fields' in kwargs:
            issue_data['fields'].update(kwargs['fields'])
        
        return self._make_request('POST', '/rest/api/3/issue', data=issue_data)
    
    def get_issue(self, issue_key: str) -> Dict:
        """
        JIRA 이슈 조회
        
        Args:
            issue_key: 이슈 키 (예: PROJECT-123)
            
        Returns:
            이슈 정보
        """
        return self._make_request('GET', f'/rest/api/3/issue/{issue_key}')
    
    def update_issue(self, issue_key: str, **kwargs) -> Dict:
        """
        JIRA 이슈 업데이트
        
        Args:
            issue_key: 이슈 키
            **kwargs: 업데이트할 필드들
            
        Returns:
            업데이트된 이슈 정보
        """
        update_data = {'fields': {}}
        
        # 필드 매핑
        field_mapping = {
            'summary': 'summary',
            'description': 'description',
            'status': 'status',
            'assignee': 'assignee',
            'priority': 'priority',
            'labels': 'labels'
        }
        
        for key, value in kwargs.items():
            if key in field_mapping:
                field_name = field_mapping[key]
                if key == 'status':
                    update_data['fields'][field_name] = {'name': value}
                elif key == 'assignee':
                    if value:
                        update_data['fields'][field_name] = {'accountId': value}
                    else:
                        update_data['fields'][field_name] = None
                elif key == 'priority':
                    update_data['fields'][field_name] = {'name': value}
                else:
                    update_data['fields'][field_name] = value
        
        return self._make_request('PUT', f'/rest/api/3/issue/{issue_key}', data=update_data)
    
    def add_comment(self, issue_key: str, comment: str) -> Dict:
        """
        JIRA 이슈에 댓글 추가
        
        Args:
            issue_key: 이슈 키
            comment: 댓글 내용
            
        Returns:
            추가된 댓글 정보
        """
        comment_data = {'body': comment}
        return self._make_request('POST', f'/rest/api/3/issue/{issue_key}/comment', data=comment_data)
    
    def search_issues(self, jql: str = "", start_at: int = 0, max_results: int = 50) -> Dict:
        """
        JQL을 사용한 이슈 검색
        
        Args:
            jql: JQL 쿼리
            start_at: 시작 인덱스
            max_results: 최대 결과 수
            
        Returns:
            검색 결과
        """
        params = {
            'jql': jql,
            'startAt': start_at,
            'maxResults': max_results
        }
        return self._make_request('GET', '/rest/api/3/search', params=params)
    
    def get_projects(self) -> List[Dict]:
        """
        프로젝트 목록 조회
        
        Returns:
            프로젝트 목록
        """
        return self._make_request('GET', '/rest/api/3/project')
    
    def get_project(self, project_key: str) -> Dict:
        """
        프로젝트 정보 조회
        
        Args:
            project_key: 프로젝트 키
            
        Returns:
            프로젝트 정보
        """
        return self._make_request('GET', f'/rest/api/3/project/{project_key}')
    
    def health_check(self) -> Dict:
        """
        JIRA 서버 상태 확인
        
        Returns:
            서버 상태 정보
        """
        try:
            return self._make_request('GET', '/health')
        except Exception as e:
            return {'status': 'unhealthy', 'error': str(e)}

class JiraIntegrationService:
    """JIRA 연동 서비스"""
    
    def __init__(self, jira_client: JiraClient = None):
        self.jira_client = jira_client or JiraClient()
    
    def create_issue_from_test_result(self, 
                                    test_id: int,
                                    test_type: str,
                                    test_name: str,
                                    test_result: str,
                                    error_message: str = None,
                                    **kwargs) -> Dict:
        """
        테스트 결과를 기반으로 JIRA 이슈 생성
        
        Args:
            test_id: 테스트 ID
            test_type: 테스트 타입 (testcase, automation, performance)
            test_name: 테스트 이름
            test_result: 테스트 결과 (Pass, Fail, Error)
            error_message: 오류 메시지
            **kwargs: 추가 정보
            
        Returns:
            생성된 이슈 정보
        """
        # 테스트 실패 시에만 이슈 생성
        if test_result not in ['Fail', 'Error']:
            return None
        
        # 이슈 요약 생성
        summary = f"테스트 실패: {test_name}"
        
        # 이슈 설명 생성
        description = f"""
**테스트 정보**
- 테스트 ID: {test_id}
- 테스트 타입: {test_type}
- 테스트 이름: {test_name}
- 테스트 결과: {test_result}
- 실패 시간: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

**오류 정보**
{error_message or '오류 정보 없음'}

**추가 정보**
{json.dumps(kwargs, indent=2, ensure_ascii=False) if kwargs else '없음'}
        """.strip()
        
        # 이슈 생성
        issue = self.jira_client.create_issue(
            summary=summary,
            description=description,
            issue_type='Bug',
            priority='High' if test_result == 'Error' else 'Medium',
            labels=['test-failure', test_type]
        )
        
        return issue
    
    def sync_issue_status(self, jira_integration_id: int) -> bool:
        """
        JIRA 이슈 상태 동기화
        
        Args:
            jira_integration_id: JIRA 연동 ID
            
        Returns:
            동기화 성공 여부
        """
        # 이 부분은 실제 데이터베이스 연동이 필요하므로
        # 나중에 구현 예정
        pass

    def get_comments(self, issue_key: str) -> List[Dict]:
        """이슈 댓글 목록 조회"""
        endpoint = f"/rest/api/3/issue/{issue_key}/comment"
        response = self._make_request('GET', endpoint)
        return response.get('comments', [])


